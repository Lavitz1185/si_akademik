@using SIAkademik.Web.Areas.DashboardGuru.Models.KelasWaliModels
@model ProsesKelulusanVM

@inject ITahunAjaranRepository TahunAjaranRepository
@inject IRombelRepository RombelRepository

@{
    var daftarTahunAjaran = await TahunAjaranRepository.GetAll(Semester.Genap);
}

<!-- Breadcrumb -->
<div class="row">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Wali Kelas</a></li>
            <li class="breadcrumb-item">
                <a asp-area="@AreaNames.DashboardGuru" asp-controller="KelasWali" asp-action="ProsesKelulusan"></a>Proses Kelulusan
            </li>
        </ol>
    </nav>
</div>

<!-- Isi Konten -->
<div class="card card-primary">
    <div class="card-header">
        <h4>Proses Kelulusan</h4>
    </div>
    <div class="padding-20">
        <div class="d-flex justify-content-start ml-auto mb-3">
            <div class="mb-0">
                <form asp-action="ProsesKelulusan" method="get" class="d-flex align-items-center" style="gap: 8px;">
                    <label asp-for="@Model.IdTahunAjaran" class="mb-0" style="font-weight: 600;">Tahun Ajaran:</label>
                    <select asp-for="@Model.IdTahunAjaran" class="form-control form-control-sm w-auto submit-on-change">
                        @if (Model.TahunAjaran is null)
                        {
                            <option selected value="@null">-- Pilih Tahun Ajaran --</option>
                        }

                        @foreach (var tahunAjaran in daftarTahunAjaran)
                        {
                            <option value="@tahunAjaran.Id">@tahunAjaran.Periode @tahunAjaran.Semester.Humanize()</option>
                        }
                    </select>

                    <label asp-for="@Model.IdRombel" class="mb-0" style="font-weight: 600;">Rombel:</label>
                    <select asp-for="@Model.IdRombel" class="form-control form-control-sm w-auto submit-on-change">
                        @if (Model.IdRombel is null)
                        {
                            <option selected value="@null">-- Pilih Rombel --</option>
                        }

                        @if (Model.TahunAjaran is not null)
                        {
                            var daftarRombel = await RombelRepository.GetAll(Model.TahunAjaran.Id, Model.Pegawai.Id);
                            @foreach (var rombel in daftarRombel.Where(r => r.Kelas.Jenjang == Jenjang.XII))
                            {
                                <option value="@rombel.Id">@rombel.Kelas.Jenjang @rombel.Kelas.Peminatan.Nama @rombel.Nama</option>
                            }
                        }
                    </select>

                    @if (Model.TahunAjaranBaru is not null)
                    {
                        <label asp-for="@Model.IdRombel" class="mb-0" style="font-weight: 600;">Tahun Ajaran Baru:</label>
                        <label asp-for="@Model.IdRombel" class="mb-0" style="font-weight: 600;">
                            @Model.TahunAjaranBaru.Periode @Model.TahunAjaranBaru.Semester.Humanize()
                        </label>
                    }

                    @if (Model.TahunAjaranBaru is not null && Model.Rombel is not null)
                    {
                        var daftarRombel = await RombelRepository.GetAll(Model.Rombel.Kelas.Id, Model.TahunAjaranBaru.Id);
                        <label asp-for="@Model.IdRombelTinggal" class="mb-0" style="font-weight: 600;">Rombel Tinggal Kelas:</label>
                        <select asp-for="@Model.IdRombelTinggal" class="form-control form-control-sm w-auto submit-on-change">
                            @if (Model.IdRombelTinggal is null)
                            {
                                <option selected value="@null">-- Pilih Rombel --</option>
                            }

                            @foreach (var rombel in daftarRombel)
                            {
                                <option value="@rombel.Id">@rombel.Kelas.Jenjang @rombel.Kelas.Peminatan.Nama @rombel.Nama</option>
                            }
                        </select>
                    }
                </form>
            </div>
        </div>

        <form asp-action="ProsesKelulusan"
              asp-route-idTahunAjaran="@Model.IdTahunAjaran"
              asp-route-idTahunAjaranBaru="@Model.IdTahunAjaranBaru"
              asp-route-idRombel="@Model.IdRombel"
              asp-route-idRombelTinggal="@Model.IdRombelTinggal"
              method="post">
            @if (Model.IdTahunAjaran is not null &&
                Model.IdTahunAjaranBaru is not null &&
                Model.IdRombel is not null &&
                Model.IdRombelTinggal is not null
            )
            {
                <div class="d-flex justify-content-center ml-auto mb-3">
                    <!-- Tombol Tambah + Info Jumlah -->
                    <div class="d-flex flex-column align-items-end ml-auto pr-4">
                        <button id="btnTambahBanyak" type="submit" class="btn btn-icon btn-primary"
                                disabled data-toggle="tooltip" title="Proses Kelulusan">
                            Proses Kelulusan<i class="fas fa-arrow-right pl-2"></i>
                        </button>

                        <!-- Info jumlah dipilih -->
                        <div>
                            <span id="selectedCount0" class="fw-semibold text-black-50">0</span> dari
                            <span id="totalCount0"></span> data dipilih
                        </div>
                    </div>
                </div>
            }

            <div class="table-responsive">
                <table id="table-akun10" class="table table-striped table-hover" id="table-akun">
                    <thead>
                        <tr>
                            <th style="max-width: 60px; text-align: center;">
                                <input id="pilihSemua0" class="select-all" type="checkbox" style="cursor:pointer;" />
                            </th>
                            <th>NIS</th>
                            <th>NISN</th>
                            <th>Nama</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.DaftarEntry.Count; i++)
                        {
                            var anggotaRombel = Model.DaftarEntry[i].AnggotaRombel;
                            <tr>
                                <td>
                                    <input asp-for="@Model.DaftarEntry[@i].IdAnggotaRombel" hidden readonly />
                                    <input asp-for="@Model.DaftarEntry[@i].Selected" data-checkbox-all="#pilihSemua0" type="checkbox" />
                                </td>
                                <td>@anggotaRombel.Siswa.NIS</td>
                                <td>@anggotaRombel.Siswa.NISN</td>
                                <td>@anggotaRombel.Siswa.Nama</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {

            // ==== FUNGSI UMUM UNTUK MANAJEMEN SETIAP TABEL ====
            function setupTableHandler(tableId, pilihSemuaId, selectedCountId, totalCountId, submitButtonSelector) {
                let table; // deklarasi variabel DataTable
                let pagingEnabled = true; // paging aktif secara default

                // Fungsi inisialisasi DataTable
                function initDataTable(enablePaging) {
                    table = $(tableId).DataTable({
                        destroy: true, // pastikan bisa reinit tanpa error
                        paging: enablePaging,
                        searching: true,
                        info: false,
                        ordering: false,
                        language: {
                            emptyTable: "Tidak ada data tersedia dalam tabel ini"
                        }
                    });
                }

                // Jalankan pertama kali dengan paging aktif
                initDataTable(true);

                // Fungsi hitung total checkbox
                function updateSelectedCount() {
                    var total = $(tableId + ' input[type="checkbox"][data-checkbox-all]').length;
                    var checked = $(tableId + ' input[type="checkbox"][data-checkbox-all]:checked').length;

                    $(selectedCountId).text(checked);
                    $(totalCountId).text(total);
                    $(submitButtonSelector).prop('disabled', checked === 0);
                }

                // Klik "Pilih Semua"
                $(pilihSemuaId).on('click', function () {
                    var isChecked = $(this).is(':checked');

                    // Hapus instance DataTable lama
                    table.destroy();

                    if (isChecked) {
                        // Reinit tanpa paging supaya semua data muncul
                        initDataTable(false);
                        // Centang semua
                        $(tableId + ' input[type="checkbox"][data-checkbox-all]').prop('checked', true);
                    } else {
                        // Reinit lagi dengan paging normal
                        initDataTable(true);
                        // Hilangkan centang semua
                        $(tableId + ' input[type="checkbox"][data-checkbox-all]').prop('checked', false);
                    }

                    updateSelectedCount();
                });

                // Klik salah satu checkbox siswa
                $(tableId).on('change', 'input[type="checkbox"][data-checkbox-all]', function () {
                    var all = $(tableId + ' input[type="checkbox"][data-checkbox-all]');
                    var checked = all.filter(':checked').length;
                    $(pilihSemuaId).prop('checked', checked === all.length);
                    updateSelectedCount();
                });

                updateSelectedCount();
            }

            // === INISIALISASI UNTUK MASING-MASING TABEL ===

            // 🟦 Tabel 1: Daftar Seluruh Siswa (Tambah ke Rombel)
            setupTableHandler(
                '#table-akun10',
                '#pilihSemua0',
                '#selectedCount0',
                '#totalCount0',
                '#btnTambahBanyak'
            );
        });
    </script>
}
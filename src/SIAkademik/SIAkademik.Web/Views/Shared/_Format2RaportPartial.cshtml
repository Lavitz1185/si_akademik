@model AnggotaRombel

@inject IPegawaiRepository PegawaiRepository;
@inject IEvaluasiSiswaRepository NilaiRepository;
@inject IJadwalMengajarRepository JadwalMengajarRepository;

@{
    Layout = null;

    var daftarPengetahuan = Model.DaftarRaport
        .Where(r => r.KategoriNilai == KategoriNilaiRaport.Pengetahuan)
        .OrderBy(r => r.JadwalMengajar!.MataPelajaran.Peminatan.Jenis)
        .ToList();

    var daftarEktrakulikuler = Model.DaftarRaport
        .Where(r => r.KategoriNilai == KategoriNilaiRaport.Ekstrakulikuler)
        .ToList();

    var kepalaSekolah = (await PegawaiRepository.GetAll()).FirstOrDefault(p => p.Jabatan.Nama.ToLower() == JabatanKhusus.KepalaSekolah.ToLower());
}

<style>
    table {
        width: 100%;
        font-size: 11px !important;
        font-family: 'Calibri' !important;
    }

    table, th, tr, td {
        border: 1px solid black;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
    }
</style>


<h1 style="font-size:16px !important; font-family:Calibri; text-align:center; margin-top:20px">LAPORAN HASIL BELAJAR</h1>

<table style="margin-top:5px">
    <thead>
        <tr>
            <th style="text-align:center;">No</th>
            <th style="text-align:center;" width="15%">Mata Pelajaran</th>
            <th style="text-align:center;">Nilai Akhir</th>
            <th style="text-align:center;">Capaian Kompetensi</th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < daftarPengetahuan.Count; i++)
        {
            var pengetahuan = daftarPengetahuan[i];
            var daftarAsesmenSumatif = (await JadwalMengajarRepository.Get(pengetahuan.JadwalMengajar!.Id))!
            .DaftarAsesmenSumatif
            .OrderBy(a => a.TujuanPembelajaran.Nomor);

            var firstAsesmenSumatif = daftarAsesmenSumatif.FirstOrDefault();

            <tr>
                <td style="text-align:center">@(i + 1)</td>
                <td style="text-align:left">@pengetahuan.JadwalMengajar!.MataPelajaran.Nama</td>
                <td style="text-align:center">@Model.NilaiAkhir(pengetahuan.JadwalMengajar!).ToString("F0")</td>
                @if (firstAsesmenSumatif is not null)
                {

                    <td>
                        Menunjukan penguasaan yang @firstAsesmenSumatif.Predikat(Model).ToLower() dalam hal
                        @(firstAsesmenSumatif.TujuanPembelajaran.Deskripsi.Substring(0, 1).ToLower() + firstAsesmenSumatif.TujuanPembelajaran.Deskripsi.Substring(1).TrimEnd('.').Trim() + (daftarAsesmenSumatif.Count() > 1 ? "," : "."))
                        @foreach (var asesmensSumatif in daftarAsesmenSumatif.Skip(1))
                        {
                            @($" serta menunjukan penguasaan yang {asesmensSumatif.Predikat(Model).ToLower()} dalam hal {asesmensSumatif.TujuanPembelajaran.Deskripsi.Substring(0, 1).ToLower() + asesmensSumatif.TujuanPembelajaran.Deskripsi.Substring(1).TrimEnd('.').Trim() + (daftarAsesmenSumatif.ElementAtOrDefault(Index.End) == asesmensSumatif ? "," : ".")}")
                        }
                    </td>
                }
            </tr>
        }
    </tbody>
</table>

<br />
<br />

<table>
    <thead>
        <tr>
            <th>No</th>
            <th width="25%">Kegiatan Ektrakulikuler</th>
            <th>Predikat</th>
            <th>Keterangan</th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < daftarEktrakulikuler.Count; i++)
        {
            var ektrakulikuler = daftarEktrakulikuler[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@ektrakulikuler.Nama</td>
                <td>@ektrakulikuler.Predikat</td>
                <td>@ektrakulikuler.Deskripsi</td>
            </tr>
        }
    </tbody>
</table>

<br />
<br />

<table style="width: 40% !important">
    <tbody>
        @{
            var jumlahSakit = Model.DaftarAbsenKelas.Where(a => a.Absensi == Absensi.Sakit).Count();
            var jumlahIjin = Model.DaftarAbsenKelas.Where(a => a.Absensi == Absensi.Ijin).Count();
            var jumlahTanpaKeterangan = Model.DaftarAbsenKelas.Where(a => a.Absensi == Absensi.Alpa).Count();
        }
        <tr>
            <td>Sakit</td>
            <td> : @jumlahSakit hari</td>
        </tr>
        <tr>
            <td>Ijin</td>
            <td> : @jumlahIjin hari</td>
        </tr>
        <tr>
            <td>Tanpa Keterangan</td>
            <td> : @jumlahTanpaKeterangan hari</td>
        </tr>
    </tbody>
</table>

<div style="display:flex;justify-content:center;align-content:end;width:100%;font-size:11px;font-family:Calibri">
    <div style="margin-right:auto">
        <p>Mengetahui</p>
        <p>Orang Tua/Wali,</p>
        <p style="color:transparent">A</p>
        <p>.............................</p>
    </div>
    <div>
        <p>Kabupaten Kupang, @TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, CultureInfos.TimeZoneInfo).ToString("d MMMM yyyy", CultureInfos.CI)</p>
        <p>Wali Kelas,</p>
        <p style="color:transparent">A</p>
        <p><b><u>@Model.Rombel.Wali.Nama</u></b></p>
        <p>NIP. -</p>
    </div>

</div>
<div style="display:flex;justify-content:center;align-content:center;width:100%;font-size:11px;;font-family:Calibri">
    <div>
        <p style="text-align:center">Mengetahui</p>
        <p style="text-align:center">Kepala Sekolah</p>
        <p style="color:transparent">A</p>
        <p style="color:transparent">A</p>
        <p><b><u>@(kepalaSekolah?.Nama ?? "-")</u></b></p>
        <p>NIP. -</p>
    </div>
</div>